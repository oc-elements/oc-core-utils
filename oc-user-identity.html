<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../iron-location/iron-location.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="oc-core-utils.html">
<link rel="import" href="oc-token-requestor-behaviour.html">
<link rel="import" href="../oc-user-api/oc-user-api.html">
<link rel="import" href="oc-store.html">



<dom-module id="oc-user-identity">
    <template>
        <app-location route="{{ route }}"></app-location>
        <app-route route="[[ route ]]" pattern="[[ _redirectPattern ]]" tail="{{ routeData }}"></app-route>

        <oc-user-api id="usersApi"></oc-user-api>
        <iron-localstorage
                id="tokenStorage"
                name="token"
                use-raw
                auto-save-disabled
                on-iron-localstorage-load="_storedTokenLoaded"
                on-iron-localstorage-load-empty="_storedTokenLoadedEmpty"
        ></iron-localstorage>
        <iron-localstorage
                id="postAuthPageStorage"
                name="post-auth-page"
                use-raw
                auto-save-disabled
                on-iron-localstorage-load="_postAuthPageStorageLoaded"
                on-iron-localstorage-load-empty="_postAuthPageStorageLoaded"
        ></iron-localstorage>
    </template>

    <script>
        /**
         * `oc-user-identity`
         * Ordercloud User Identity
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class OcUserIdentity extends Ordercloud.TokenRequestor(Ordercloud.ReduxMixin(Polymer.Element)) {
            static get is() { return 'oc-user-identity'; }
            static get properties() {
                return {
                    /**
                     * Token redirect uri you've registered for this client
                     */
                    _tokenRedirectUri: {
                        type:String,
                        statePath: 'config.tokenRedirectUri'
                    },
                    /**
                     * Page to after sign out.
                     */
                    signedOutPage: String,
                    /**
                     * The page to navigate too after login
                     */
                    _signInRequested : {
                        type: Boolean,
                        value: false
                    },
                    _tokenLoadComplete: {
                        type: Boolean,
                        value: false
                    },
                    _tokenReady: {
                        type: Boolean,
                        value: false
                    },
                    _postAuthPage: {
                        type: String,
                        value: "/"
                    }

                };
            }
            static get observers() {
                return[
                    '_routeChanged(route, _tokenRedirectUri, _tokenLoadComplete)',
                    '_signIn(_signInRequested, _tokenLoadComplete)',
                    '_pageToAfterSignIn(_postAuthPage, _tokenReady)'
                ]
            }

            connectedCallback() {
                super.connectedCallback();
            }

            ready() {
                super.ready();
            }

            _storedTokenLoaded() {
                this._storedToken = this.$.tokenStorage.value;
                this._tokenLoadComplete = true;
                console.log('Stored token loaded');
            }

            _storedTokenLoadedEmpty() {
                this._tokenLoadComplete = true;
                console.log('No stored token');
            }

            _postAuthPageStorageLoaded() {
                this._postAuthPage = this.$.postAuthPageStorage.value;
            }

            signIn() {
                this._signInRequested = true;
            }

            _signIn() {
                if(this._tokenLoadComplete && this._signInRequested ) {
                    if (this._storedToken) {
                        console.log('Sign-in: Using stored token');
                        this._setToken(this._storedToken);
                        this.dispatch('loginUser', this._storedToken).then(() => this.dispatch('fetchUserIfNeeded'));
                    } else {
                        console.log('Sign-in: Requesting new token');
                        this._requestImplicitGrant();
                    }
                }
            }

            /**
             * Gets a new token from auth server
             */
            refreshToken() {
                console.log('Sign-in: Requesting new token');
                //clear the current token
                this.dispatch('clearToken');
                this._requestImplicitGrant();
            }

            _routeChanged(route, redirectPattern, tokenLoadComplete) {

                if ((!redirectPattern)
                    || (route.path.split("/").pop() !== redirectPattern.split("/").pop())
                    || (!tokenLoadComplete)) {
                    return;
                }
                if (route.__queryParams.access_token) {
                    console.log('Token received on ' + redirectPattern);

                    this.$.tokenStorage.value = route.__queryParams.access_token;
                    this.$.tokenStorage.save();
                    this._setToken(route.__queryParams.access_token);
                    this._tokenReady = true;
                }
            }

            _pageToAfterSignIn() {
                if(this._tokenReady) {
                    console.log('Pushing window state');
                    //window.history.pushState(null, '', this._postAuthPage);
                    if ((this._postAuthPage === null) || (this._postAuthPage.indexOf('oauth') !== -1)){
                        this._postAuthPage = "/"
                    }
                    window.location.href = this._postAuthPage;
                }
            }

            _setToken(jwtToken) {
                if (jwtToken) {
                    let jwtClaimSetEncoded = jwtToken.split(".")[1];
                    this.dispatch('loginUser', jwtToken).then(() => this.dispatch('fetchUserIfNeeded'));

                } else {
                    this.dispatch('clearToken');
                }
            }

            signOut() {
                this.$.tokenStorage.value = null;
                this.$.tokenStorage.save();
                this._setToken(null);
                this.dispatch('logoutUser');

                //redirect to login
                this._requestSignOut();
            }

        }

        window.customElements.define(OcUserIdentity.is, OcUserIdentity);
    </script>
</dom-module>
