
<link rel="import" href="redux-action-types.js">

<script>
    var Ordercloud = window.Ordercloud || {};
    (function() {


        /**
         * Gets the logged in user
         * @returns {{type}}
         */
        function requestUser() {
            return {
                type: REQUEST_USER
            }
        }

        /**
         * Set the logged in user
         * @param payload
         * @returns {{type, user: *, receivedAt: number}}
         */
        function receiveUser (payload) {
            return {
                type: RECEIVE_USER,
                user: payload,
                receivedAt: Date.now()
            }
        }

        function fetchUser() {
            return dispatch => {
                dispatch(requestUser());
                return fetch(_generateUrl('users/logged_in'))
                    .then(response => response.json())
                    .then(json => dispatch(receiveUser(json)))
            }
        }


        function shouldFetchUser(state) {
            const user = state.identity.user;
            if (!user) {
                return true
            } else if (user.isFetching) {
                return false
            } else {
                return user.didInvalidate
            }
        }

        function fetchUserIfNeeded() {
            // Note that the function also receives getState()
            // which lets you choose what to dispatch next.

            // This is useful for avoiding a network request if
            // a cached value is already available.

            return (dispatch, getState) => {
                if (shouldFetchUser(getState())) {
                    // Dispatch a thunk from thunk!
                    return dispatch(fetchUser());
                } else {
                    // Let the calling code know there's nothing to wait for.
                    return Promise.resolve();
                }
            }
        }


        /**
         * Set the logged in user
         * @returns {{type}}
         */
        function loginUser (payload) {
            return {
                type: LOGIN_USER,
                token: payload
            }
        }

        /**
         * Set the logged in user
         * @returns {{type}}
         */
        function logoutUser () {
            return {
                type: LOGOUT_USER
            }
        }

        /**
         * Clear the token
         * @returns {{type}}
         */
        function clearToken () {
            return {
                type: CLEAR_TOKEN,
                receivedAt: Date.now()
            }
        }

        /**
         * Set the current organisation
         * @param payload
         * @returns {{type, profile: *,id : number, receivedAt: number}}
         */
        function receiveOrganisation (payload) {
            return {
                type: RECEIVE_ORGANISATION,
                profile: payload.profile,
                id: payload.id,
                receivedAt: Date.now()
            }
        }

        /**
         * Clears the organisation data
         * @returns {{type}}
         */
        function clearOrganisation () {
            return {
                type: CLEAR_ORGANISATION
            }
        }

        /**
         *
         * @param payload
         * @returns {{type, clientId: *, receivedAt: number}}
         */
        function receiveClientId (payload) {
            return {
                type: RECEIVE_CLIENT_ID,
                clientId: payload,
                receivedAt: Date.now()
            }
        }

        /**
         * Generates a valid api url by prepending thhe host and adding resource/ before the rest of the path
         * @param uri un generated uri on containing the path after /resource in api-docs
         * @returns {string} uri that has the host and /resource prepended
         */
        function _generateUrl(uri){
            return this.getState().config.apiHostUrl + 'resource/' + uri;
        }

        function _generateRequest (request) {
            return _generateRequest(request, false);
        }

        function _generateRequest (request, marketplace) {

            //check if the call is a marketplace connection
            let clientId =  this.getState().config.clientId;
            if(!marketplace){
                clientId = Ordercloud.select.clientId(this.getState());
            }

            request.headers.Authorization = request.headers.Authorization || 'Bearer ' + this.getState().identity.token;
            request.headers['X-Ordercloud-Organisation'] = request.headers['X-Ordercloud-Organisation'] || clientId;
            var ironRequest = request.generateRequest();
            request.headers = {};
            //allows the errors to bubble up and be caught by window.oneError
            request.bubbles = true;
            return ironRequest.completes.catch(this._normalizeError.bind(this, ironRequest));
        }

        /**
         *
         * @param payload
         * @returns {{type, clientId: *, receivedAt: number}}
         */
        function receiveConfig (payload) {
            return {
                type: RECEIVE_CONFIG,
                clientId: payload.clientId,
                organisationId: payload.organisationId,
                tokenRedirectUri: payload.tokenRedirectUri,
                authClientId: payload.authClientId,
                authHostUrl: payload.authHostUrl,
                apiHostUrl: payload.apiHostUrl,
                environment: payload.environment,
                receivedAt: Date.now()
            }
        }

        Ordercloud.actions = {
            receiveUser,
            loginUser,
            logoutUser,
            clearToken,
            receiveOrganisation,
            clearOrganisation,
            receiveClientId,
            receiveConfig,
            fetchUserIfNeeded
        }

    }());
</script>