<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="oc-store.html">
<iron-request id="xhr"></iron-request>
<script>
    /*
 * Ordercloud API Mixin that allows requesting of tokens.
 * @polymer
 * @mixinFunction
 */
    Ordercloud = window.Ordercloud || { };
    Ordercloud.TokenRequestor = Polymer.dedupingMixin((superclass) =>

        /*
             * @polymer
             * @mixinClass
             */
        class TokenRequestor extends Ordercloud.ReduxMixin( superclass) {
            constructor() {
                super();
            }

            static get properties() {
                return {
                    _clientId : {
                        type: String,
                        statePath: 'config.clientId'
                    },
                    _authHostUrl: {
                        type: String,
                        statePath: 'config.authHostUrl'
                    },
                    _tokenRedirectUri:{
                        type: String,
                        statePath: 'config.tokenRedirectUri'
                    },
                    _authClientId:{
                        type: String,
                        statePath: 'config.authClientId'
                    }

                };
            }

            ready() {
                super.ready();
            }

            /**
             *Requests a token from the auth serverwith implicit grant type
             */
            _requestImplicitGrant() {
                if (this._clientId && this._authHostUrl && this._tokenRedirectUri && this._authClientId) {
                    this._save('post-auth-page', window.location.href);
                    window.location = [
                        this._authHostUrl, 'oauth/implicit?response_type=token&client_id=', this._authClientId,
                        '&redirect_uri=', encodeURIComponent(this._.tokenRedirectUri)
                    ].join('');
                } else {
                    console.error('Core components not configured. Please initialise oc-config element before attempting authorisation.');
                }
            }


            /**
             *Requests link to signout of the app
             */
            _requestSignOut() {
                if (this._clientId && this._authHostUrl && this._tokenRedirectUri && this._authClientId) {
                    this._save('post-auth-page', window.location.href);
                    window.location = [
                        this._authHostUrl, 'sign-out?next=',
                        encodeURIComponent(
                            'oauth/implicit?response_type=token&client_id=' +
                            this._authClientId +
                            '&redirect_uri=' +
                            this._tokenRedirectUri
                        )
                    ].join('');
                } else {
                    console.error('Core components not configured. Please initialise oc-config element before attempting authorisation.');

                }
            }

            /**
             * Saves the value to localStorage.
             * If `value` is null or undefined, deletes localStorage.
             */
            _save(key, value) {
                try {
                    if (value === null || value === undefined) {
                        window.localStorage.removeItem(key);
                    } else {
                        window.localStorage.setItem(key, /** @type {string} */ (value));
                    }
                }
                catch(ex) {
                    // Happens in Safari incognito mode,
                    this.errorMessage = ex.message;
                    Polymer.Base._error("Could not save to localStorage. Incognito mode may be blocking this action", ex);
                }
            }
        }
    )
</script>
